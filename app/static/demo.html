<!DOCTYPE html> <!-- [AI assisted] -->
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>LMT Defence Intercept Demo</title>
  <style>
    body { font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif; margin: 2rem; }
    h1 { margin-bottom: 0.5rem; }
    label { display: block; margin-top: 0.5rem; }
    input { margin-left: 0.5rem; }
    button { margin-top: 1rem; margin-right: 0.5rem; }
    table { border-collapse: collapse; margin-top: 1.5rem; width: 100%; font-size: 0.9rem; }
    th, td { border: 1px solid #ccc; padding: 0.25rem 0.5rem; text-align: right; }
    th { background: #f5f5f5; }
    .status { margin-top: 1rem; font-size: 0.9rem; }
    .status span { font-weight: 600; }
  </style>
</head>
<body>
  <h1>LMT Defence Demo</h1>
  <p>
    This demo simulates the radar system (1/second frequency):
    <ul>
      <li>Calls <code>/intercept</code> <strong>once</strong> at start to get static intercept point C</li>
      <li><strong>Radar sends</strong> threat position B to the demo every second via <code>/radar/stream</code> (Server-Sent Events)</li>
      <li>Interceptor position A is computed in the browser, moving from base toward C</li>
    </ul>
    <strong>B</strong>: Threat lat/lon sent by radar (1 Hz) | <strong>C</strong>: Static intercept point | <strong>A</strong>: Interceptor in HTML
  </p>

  <form id="config-form">
    <label>
      Speed (m/s):
      <input type="number" id="speed_ms" value="60" step="1" required />
    </label>
    <label>
      Altitude (m):
      <input type="number" id="altitude_m" value="500" step="10" required />
    </label>
    <label>
      Heading (deg):
      <input type="number" id="heading_deg" value="90" step="1" required />
    </label>
    <label>
      Latitude:
      <input type="number" id="latitude" value="56.516441" step="0.000001" required />
    </label>
    <label>
      Longitude:
      <input type="number" id="longitude" value="21.109256" step="0.000001" required />
    </label>
    <button type="button" id="start-btn">Start</button>
    <button type="button" id="stop-btn" disabled>Stop</button>
  </form>

  <div class="status">
    Status: <span id="status-text">Idle</span><br />
    Current map:
    <a id="map-link" href="#" target="_blank">none</a>
  </div>

  <table>
    <thead>
      <tr>
        <th>t (s)</th>
        <th>Threat lat</th>
        <th>Threat lon</th>
        <th>Intercept lat</th>
        <th>Intercept lon</th>
        <th>Interceptor lat</th>
        <th>Interceptor lon</th>
        <th>Base</th>
        <th>Interceptor type</th>
        <th>Cost (EUR)</th>
      </tr>
    </thead>
    <tbody id="results-body"></tbody>
  </table>

  <script>
    const R_LAT = 111320.0;

    function deg2rad(d) { return d * Math.PI / 180.0; }

    function moveThreat(lat, lon, headingDeg, speedMs, dtSeconds) {
      const headingRad = deg2rad(headingDeg);
      const vNorth = speedMs * Math.cos(headingRad);
      const vEast = speedMs * Math.sin(headingRad);

      const dNorth = vNorth * dtSeconds;
      const dEast = vEast * dtSeconds;

      const latRad = deg2rad(lat);
      const mPerDegLat = R_LAT;
      const mPerDegLon = R_LAT * Math.cos(latRad) || 1.0;

      const newLat = lat + dNorth / mPerDegLat;
      const newLon = lon + dEast / mPerDegLon;
      return { lat: newLat, lon: newLon };
    }

    const startBtn = document.getElementById("start-btn");
    const stopBtn = document.getElementById("stop-btn");
    const statusText = document.getElementById("status-text");
    const resultsBody = document.getElementById("results-body");
    const mapLink = document.getElementById("map-link");

    let eventSource = null;
    let t = 0;
    let threatLat = 0;
    let threatLon = 0;
    let speedMs = 0;
    let altitudeM = 0;
    let headingDeg = 0;
    
    // Static values from initial /intercept call (never change)
    let baseLat = null;
    let baseLon = null;
    let interceptLat = null;
    let interceptLon = null;
    let timeToIntercept = null;
    let baseName = null;
    let interceptorType = null;
    let cost = null;
    let mapUrl = null;

    function setStatus(text) {
      statusText.textContent = text;
    }

    function calculateInterceptorPosition(tSeconds) {
      // I(t) = A + (C - A) * min(1, t/T)
      if (baseLat == null || interceptLat == null || timeToIntercept == null) {
        return { lat: null, lon: null };
      }
      
      const lambda = Math.min(1.0, tSeconds / timeToIntercept);
      const lat = baseLat + (interceptLat - baseLat) * lambda;
      const lon = baseLon + (interceptLon - baseLon) * lambda;
      return { lat, lon };
    }

    function onRadarUpdate(data) {
      // Radar sends info to the demo: threat position at this second
      t = data.second;
      threatLat = data.latitude;
      threatLon = data.longitude;

      const interceptorPos = calculateInterceptorPosition(t);

      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${t}</td>
        <td>${threatLat.toFixed(6)}</td>
        <td>${threatLon.toFixed(6)}</td>
        <td>${interceptLat != null ? interceptLat.toFixed(6) : ""}</td>
        <td>${interceptLon != null ? interceptLon.toFixed(6) : ""}</td>
        <td>${interceptorPos.lat != null ? interceptorPos.lat.toFixed(6) : ""}</td>
        <td>${interceptorPos.lon != null ? interceptorPos.lon.toFixed(6) : ""}</td>
        <td>${baseName ?? ""}</td>
        <td>${interceptorType ?? ""}</td>
        <td>${cost ?? ""}</td>
      `;
      resultsBody.appendChild(row);
      setStatus("Running, t = " + t + " s (radar updating)");

      if (timeToIntercept != null && t >= timeToIntercept) {
        if (eventSource) { eventSource.close(); eventSource = null; }
        setStatus("Finished – interceptor reached intercept point at t = " + t + " s");
        startBtn.disabled = false;
        stopBtn.disabled = true;
      }
    }

    function stopStream() {
      if (eventSource) {
        eventSource.close();
        eventSource = null;
      }
      setStatus("Stopped at t = " + t + " s");
      startBtn.disabled = false;
      stopBtn.disabled = true;
    }

    startBtn.addEventListener("click", async () => {
      if (eventSource !== null) return;

      speedMs = parseFloat(document.getElementById("speed_ms").value);
      altitudeM = parseFloat(document.getElementById("altitude_m").value);
      headingDeg = parseFloat(document.getElementById("heading_deg").value);
      threatLat = parseFloat(document.getElementById("latitude").value);
      threatLon = parseFloat(document.getElementById("longitude").value);

      resultsBody.innerHTML = "";
      t = 0;
      setStatus("Calling /intercept to get static intercept point...");

      startBtn.disabled = true;
      stopBtn.disabled = false;

      try {
        const payload = {
          speed_ms: speedMs,
          altitude_m: altitudeM,
          heading_deg: headingDeg,
          latitude: threatLat,
          longitude: threatLon,
          report_time: new Date().toISOString()
        };

        const resp = await fetch("/intercept", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const data = await resp.json();

        if (data.intercept_latitude == null || data.intercept_longitude == null) {
          setStatus("Error: No intercept point found. " + (data.note || ""));
          startBtn.disabled = false;
          stopBtn.disabled = true;
          return;
        }

        baseLat = data.base_latitude;
        baseLon = data.base_longitude;
        interceptLat = data.intercept_latitude;
        interceptLon = data.intercept_longitude;
        timeToIntercept = data.time_to_intercept_s;
        baseName = data.base_name;
        interceptorType = data.interceptor_type;
        cost = data.calculated_cost_eur;
        mapUrl = data.map_url;

        if (mapUrl) {
          mapLink.href = mapUrl;
          mapLink.textContent = "Open in Google Maps";
        }

        // Radar sends info to the demo at 1 Hz via Server-Sent Events
        // Ensure stream runs long enough: timeToIntercept + 30s buffer, capped at 3600s (1 hour)
        const maxSeconds = Math.min(3600, Math.ceil((timeToIntercept || 300) + 30));
        const streamUrl = "/radar/stream?latitude=" + encodeURIComponent(threatLat) +
          "&longitude=" + encodeURIComponent(threatLon) +
          "&speed_ms=" + encodeURIComponent(speedMs) +
          "&altitude_m=" + encodeURIComponent(altitudeM) +
          "&heading_deg=" + encodeURIComponent(headingDeg) +
          "&max_seconds=" + maxSeconds;

        setStatus("Running – radar sending updates at 1/second...");
        eventSource = new EventSource(streamUrl);

        eventSource.onmessage = (e) => {
          const data = JSON.parse(e.data);
          // Log updates in browser console
          console.log("Radar update received t=" + data.second, data.latitude.toFixed(6), data.longitude.toFixed(6));
          onRadarUpdate(data);
        };

        eventSource.onerror = () => {
          if (eventSource) { eventSource.close(); eventSource = null; }
          stopStream();
        };
      } catch (err) {
        console.error(err);
        setStatus("Error: " + err);
        startBtn.disabled = false;
        stopBtn.disabled = true;
      }
    });

    stopBtn.addEventListener("click", () => {
      if (eventSource !== null) {
        eventSource.close();
        eventSource = null;
        stopStream();
      }
    });
  </script>
</body>
</html>
